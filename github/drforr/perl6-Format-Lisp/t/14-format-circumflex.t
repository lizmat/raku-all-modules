use v6;

use Test;
use lib 't/lib';
use Utils;
use Format::Lisp;

my $*fl = Format::Lisp.new;

subtest {
	1;
	#`(
	# (def-format-test format.^.{.1
	#   "窿窿" ('(1 2 3 4 5)) "X 1 Y 2 X 3 Y 4 X 5")
	# 
	ok def-format-test(
		Q{窿窿},
		( [ 1, 2, 3, 4, 5 ] ),
		Q{X 1 Y 2 X 3 Y 4 X 5},
	), Q[format.^.{.1];
	)

	#`(
	# (def-format-test format.^.{.2
	#   "窿窿" ('(1 2 3 4)) "X 1 Y 2 X 3 Y 4")
	# 
	ok def-format-test(
		Q{窿窿}, ( [ 1, 2, 3, 4 ] ), Q{X 1 Y 2 X 3 Y 4}
	), Q[format.^.{.2];
	)

	#`(
	# (def-format-test format.^.{.3
	#   "1{A^A}" ('(1)) "1")
	# 
	ok def-format-test( Q{1{A^A}}, ( [ 1 ] ), Q{1} ), Q[format.^.{.3];
	)

	#`(
	# (def-format-test format.^.{.4
	#   "0{A^A}" ('(1)) "")
	# 
	ok def-format-test( Q{0{A^A}}, ( [ 1 ] ), Q{} ), Q[format.^.{.4];
	)

	#`(
	# (def-format-test format.^.{.5
	#   "1{A^A}" ('(1 2 3)) "12")
	# 
	ok def-format-test(
		Q{1{A^A}}, ( [ 1, 2, 3 ] ), Q{12}
	), Q[format.^.{.5];
	)

	#`(
	# (def-format-test format.^.{.6
	#   "窿窿稗窿ěū订⒈并镫溴姝骘蝽狒翦篝邀窿窿稗窿爆铂超船惮┈邀辈┈眼骘蝽狒蕻遁｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻窿窿鲛窿ěū卑北辈┅⒈泊刀镫溴姝骘蝽狒翦篝邀窿窿鲛窿爆铂超船惮冬艾番脯宫卑北辈┈邀辈吹洱┈眼骘蝽狒蕻份｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻，侈窿ěū卑┅⒈渤吹斗镫溴姝骘蝽狒翦篝邀，侈窿爆铂超船惮冬番脯宫卑┈邀辈炒刀俘┈眼骘蝽狒蕻篙｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻铂＾窿立ěū卑癌⒈渤吹斗赴镫溴姝骘蝽狒翦篝邀铂＾窿爆铂超船惮冬番脯宫卑莠┈邀辈炒刀犯褒┈眼骘蝽狒蕻馆｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻卑，＾窿ěū卑┅镫溴姝骘蝽狒翦篝邀，＾窿爆铂超船惮冬番脯宫卑┈邀┈眼骘蝽狒蕻卑莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻北，，＾窿ěū卑┅镫溴姝骘蝽狒翦篝邀，，＾窿爆铂超船惮冬番脯宫卑┈邀┈眼骘蝽狒蕻北莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻辈，爆厕窿ěū卑┅⒈渤吹斗腹镫溴姝骘蝽狒翦篝邀，爆厕窿爆铂超船惮冬番脯宫卑┈邀辈炒刀犯过┈眼骘蝽狒蕻辈莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻背，，鲛窿ěū卑┅⒉炊镫溴姝骘蝽狒翦篝邀，，鲛窿爆铂超船惮冬番脯宫卑┈邀泊洱┈眼骘蝽狒蕻背莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻贝，，鲛窿ěū卑北┅⒉炊镫溴姝骘蝽狒翦篝邀，，鲛窿爆铂超船惮冬番脯宫卑北┈邀泊洱┈眼骘蝽狒蕻贝莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻钡，，鲛窿ěū卑北辈┅⒉炊镫溴姝骘蝽狒翦篝邀，，鲛窿爆铂超船惮冬番脯宫卑北辈┈邀泊洱┈眼骘蝽狒蕻钡莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻倍，，鲛窿ěū卑北辈背┅⒉炊镫溴姝骘蝽狒翦篝邀，，鲛窿爆铂超船惮冬番脯宫卑北辈背邀泊洱┈眼骘蝽狒蕻倍莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻狈，，鲛窿ěū卑北辈背贝┅⒉炊涪镫溴姝骘蝽狒翦篝邀，，鲛窿爆铂超船惮冬番脯宫卑北辈背贝┈邀泊陡┈眼骘蝽狒蕻狈莼ㄤ彐骘蝽狒翦篝骘蝽狒蕻备霈鲛窿è扉篝ū盹篝痫箝糸鲥骈铛愆ū盹篝痫箝糸鲥骈铛愆暴刎娘瞌翳轭轸狃痨殂徕戾ㄤ彐骘蝽狒翦篝骘蝽狒蕻惫艾霈鲛窿è扉篝ū盹篝痫箝糸鲥骈铛愆ū盹篝痫箝糸鲥骈铛愆暴刎娘瞌翳轭轸狃痨殂徕戾ㄤ彐骘蝽狒翦篝骘蝽狒蕻舶艾霈鲛窿è扉篝ū盹篝痫箝糸鲥骈铛愆盹篝痫箝糸鲥骈铛暴⒈刎娘瞌翳轭轸狃痨殂徕戾｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻脖爆鲛窿ě铋铋旦⒏范镫溴姝骘蝽狒翦篝邀爆鲛窿伍飕脯伍飕番艾冬爆┈邀阜洱┈眼骘蝽狒蕻脖莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻膊艾鲛窿ěǔ铋旦⒏范镫溴姝骘蝽狒翦篝邀艾鲛窿超脯爆番超冬伍飕┈邀阜洱┈眼骘蝽狒蕻膊莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻渤爆铂鲛窿ěò穿⒈渤镫溴姝骘蝽狒翦篝邀爆铂鲛窿艾爆艾铂艾超超┈邀辈除┈眼骘蝽狒蕻渤莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻泊爆铂鲛窿ěò铋穿⒈渤储镫溴姝骘蝽狒翦篝邀爆铂鲛窿艾爆艾铂艾超伍飕┈邀辈炒┈眼骘蝽狒蕻泊莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻驳爆爆鲛窿ěò铋穿⒈渤镫溴姝骘蝽狒翦篝邀爆爆鲛窿艾爆艾铂艾超伍飕┈邀辈除┈眼骘蝽狒蕻驳莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻捕ж撖窿ěū畅⒈渤镫溴姝骘蝽狒翦篝邀ж撖窿爆铂┈邀辈除┈眼骘蝽狒蕻捕莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻卜霈ж撖窿ěò＼铋＼旦⒈渤镫溴姝骘蝽狒翦篝邀霈ж撖窿艾爆邀佚铂伍飕超邀佚船艾┈邀辈除┈眼骘蝽狒蕻卜莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻哺ж鲛窿ěò＼铋＼旦⒈渤镫溴姝骘蝽狒翦篝邀ж鲛窿艾爆邀佚铂伍飕超邀佚船艾┈邀辈除┈眼骘蝽狒蕻哺莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻补霈鲛窿ěò＼＼＼＼＼旦⒈渤镫溴姝骘蝽狒翦篝邀霈鲛窿艾铂爆邀邀佚铂惮邀佚超邀邀船爆铂┈邀辈除┈眼骘蝽狒蕻补莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻嘲КК撖窿ěū畅镫溴姝骘蝽狒翦篝邀КК撖窿爆铂┈邀┈眼骘蝽狒蕻嘲莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻潮爆霈鲛窿ěǎ茚铋癌阿镫溴姝骘蝽狒翦篝邀爆霈鲛窿邀猃伍飕┈邀褒┈眼骘蝽狒蕻潮莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻巢霈爆鲛窿ěǎ茚铋癌阿镫溴姝骘蝽狒翦篝邀霈爆鲛窿邀猃伍飕┈邀褒┈眼骘蝽狒蕻巢莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻吵霈霈鲛窿ěǎ茚＼铋癌镫溴姝骘蝽狒翦篝邀霈霈鲛窿邀猃邀猃伍飕┈邀┈眼骘蝽狒蕻吵莼眼藻篝镦轭箝溴];

subtest {
	1;
	#`(
	# (def-format-test format.^.\:{.1
	#   ":{A^AA}" ('((1)(2 3 4)(5 6 7 8))) "1234567")
	# 
	ok def-format-test(
		Q{窿撖窿窿莠铂超莠惮冬番┈邀辈炒刀俘┈眼骘蝽狒蕻蝴陛｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎蝴窿稗窿窿ěè暴ú穿ǖ俯┅⒈驳镫溴姝骘蝽狒翦篝邀蝴窿稗窿窿莠铂超莠惮冬番┈邀辈谍┈眼骘蝽狒蕻蝴草｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎蝴＾窿ěè暴ú穿īǖ俯┄┅⒈驳暴镫溴姝骘蝽狒翦篝邀蝴＾窿莠铂超莠莠惮冬番莠┈邀辈谍┈眼骘蝽狒蕻蝴齿｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎蝴＾窿＾窿＾窿＾窿ěè暴ú穿īǖ俯┄┅⒈渤吹斗涪暴镫溴姝骘蝽狒翦篝邀蝴＾窿＾窿＾窿＾窿莠铂超莠莠惮冬番莠┈邀辈炒刀犯┈眼骘蝽狒蕻蝴摧｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎蝴鲛窿ěè畅ò┄穿ò旦ū俯┅⒉炊镫溴姝骘蝽狒翦篝邀蝴鲛窿爆铂莠莠铂莠艾莠爆冬番┈邀泊洱┈眼骘蝽狒蕻蝴递｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎蝴鲛窿ěè铋飑铋暴ū博┅⒈并镫溴姝骘蝽狒翦篝邀蝴鲛窿伍莠伍飕莠爆┈邀辈┈眼骘蝽狒蕻蝴遁｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎蝴鲛窿ěè＼暴ǎ荠博ò畅ū穿┅⒈泊镫溴姝骘蝽狒翦篝邀蝴鲛窿邀莠邀莠艾莠爆┈邀辈待┈眼骘蝽狒蕻蝴份｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎蝴霈侈窿ěè暴ú癌ǔ穿ǖ订┅⒈岸镫溴姝骘蝽狒翦篝邀蝴霈侈窿爆莠铂莠超莠惮┈邀卑洱┈眼骘蝽狒蕻蝴篙｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎蝴超鲛窿ěè暴ú癌ǔ穿ǖ订┅⒈岸镫溴姝骘蝽狒翦篝邀蝴超鲛窿爆莠铂莠超莠惮┈邀卑洱┈眼骘蝽狒蕻蝴馆｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎卑蝴霈侈窿ěè＼暴┅⒈镫溴姝骘蝽狒翦篝邀蝴霈侈窿邀荸邀饼┈眼骘蝽狒蕻蝴卑莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎北蝴铂鲛窿ěè＼暴┅⒈镫溴姝骘蝽狒翦篝邀蝴铂鲛窿邀荸邀饼┈眼骘蝽狒蕻蝴北莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎辈蝴霈鲛窿ěè癌ò暴ū博ǔ旦ù订┅氨捕镫溴姝骘蝽狒翦篝邀蝴霈鲛窿爆铂莠艾爆莠爆艾莠超超莠船惮┈邀氨捕┈眼骘蝽狒蕻蝴辈莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎背蝴霈鲛窿ěè癌ǎ茚＼暴ǎ芰＼博ū畅┅氨尝镫溴姝骘蝽狒翦篝邀蝴霈鲛窿爆铂莠邀猃邀笼莠邀笼邀笼莠爆铂┈邀氨除┈眼骘蝽狒蕻蝴背莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎贝蝴侈窿ěè暴┅⒈镫溴姝骘蝽狒翦篝邀蝴侈窿┈邀饼┈眼骘蝽狒蕻蝴贝莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎钡蝴超撖窿ěè暴┅⒈镫溴姝骘蝽狒翦篝邀蝴超撖窿┈邀饼┈眼骘蝽狒蕻蝴钡莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎倍蝴撖窿ěè暴┅镫溴姝骘蝽狒翦篝邀蝴撖窿┈邀┈眼骘蝽狒蕻蝴倍莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎狈蝴，鞭窿ěè暴ú卑┄猢ù┄┄订ǚ俯┅⒉车发镫溴姝骘蝽狒翦篝邀蝴，鞭窿莠铂卑莠超邀猃邀恺莠莠惮邀莠莠番┈邀渤捣┈眼骘蝽狒蕻蝴狈莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎备蝴爆＾窿ěè暴ú卑┄猢ù┄┄订ǚ俯┅⒉车发镫溴姝骘蝽狒翦篝邀蝴爆＾窿莠铂卑莠超邀猃邀恺莠莠惮邀莠莠番┈邀渤捣┈眼骘蝽狒蕻蝴备莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎惫蝴，＾窿ěè暴īú卑┄猢ù┄┄订ǚ俯┅镫溴姝骘蝽狒翦篝邀蝴，＾窿莠莠铂卑莠超邀猃邀恺莠莠惮邀莠莠番┈邀┈眼骘蝽狒蕻蝴惫莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎舶蝴艾鲛窿ěè暴ū博铋畅ú穿┅⒉储镫溴姝骘蝽狒翦篝邀蝴艾鲛窿艾莠爆莠伍飕莠铂┈邀泊┈眼骘蝽狒蕻蝴舶莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎脖蝴爆鲛窿ěè暴ū博铋畅ú穿┅⒈炒镫溴姝骘蝽狒翦篝邀蝴爆鲛窿艾莠爆莠伍飕莠铂┈邀背待┈眼骘蝽狒蕻蝴脖莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎膊蝴爆爆鞭窿ěè暴ú畅ù订ǚ癌┅镫溴姝骘蝽狒翦篝邀蝴爆爆鞭窿莠铂莠船惮莠番脯宫┈邀┈眼骘蝽狒蕻蝴膊莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎渤蝴爆铂侈窿ěè暴ú畅ù订ǚ癌┅镫溴姝骘蝽狒翦篝邀蝴爆铂侈窿莠铂莠船惮莠番脯宫┈邀┈眼骘蝽狒蕻蝴渤莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎泊蝴爆铂鞭窿ěè暴ú畅ù订ǚ癌┅⒈泊发镫溴姝骘蝽狒翦篝邀蝴爆铂鞭窿莠铂莠船惮莠番脯宫┈邀辈捶┈眼骘蝽狒蕻蝴泊莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎驳蝴爆艾鞭窿ěè暴ú畅ù订ǚ癌┅⒈泊发镫溴姝骘蝽狒翦篝邀蝴爆艾鞭窿莠铂莠船惮莠番脯宫┈邀辈捶┈眼骘蝽狒蕻蝴驳莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎捕蝴超铂鞭窿ěè暴ú畅ù订ǚ癌┅⒈泊发镫溴姝骘蝽狒翦篝邀蝴超铂鞭窿莠铂莠船惮莠番脯宫┈邀辈捶┈眼骘蝽狒蕻蝴捕莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎卜蝴霈铂侈窿ěè卑┄舶┄嘲┄窗┅⒊按阿镫溴姝骘蝽狒翦篝邀蝴霈铂侈窿爆卑莠铂舶莠超嘲莠船窗┈邀嘲垂┈眼骘蝽狒蕻蝴卜莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎哺蝴爆霈侈窿ěè珐ū卑┄舶┄嘲┄窗┅⒎窗镫溴姝骘蝽狒翦篝邀蝴爆霈侈窿艾莠爆卑莠铂舶莠超嘲莠船窗┈邀反褒┈眼骘蝽狒蕻蝴哺莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎补蝴爆铂鲛窿ěè癌ū卑┄舶┄嘲┄窗┄蛋┅氨暗阿镫溴姝骘蝽狒翦篝邀蝴爆铂鲛窿艾莠爆卑莠铂舶莠超嘲莠船窗莠艾蛋┈邀氨暗褒┈眼骘蝽狒蕻蝴补莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎嘲蝴爆铂鲛窿ěè铋癌┅阿镫溴姝骘蝽狒翦篝邀蝴爆铂鲛窿伍飕┈邀褒┈眼骘蝽狒蕻蝴嘲莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎潮蝴，超侈窿ěè暴ú暴ǔ暴ù暴ǖ暴┅⒋耽镫溴姝骘蝽狒翦篝邀蝴，超侈窿莠铂莠超铂莠船超铂莠惮船超铂┈邀吹┈眼骘蝽狒蕻蝴潮莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎巢蝴铂，侈窿ěè暴ú暴ǔ暴ù暴ǖ暴┅⒈吹镫溴姝骘蝽狒翦篝邀蝴铂，侈窿莠铂莠超铂莠船超铂莠惮船超铂┈邀贝谍┈眼骘蝽狒蕻蝴巢莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎吵蝴艾超＾窿ěè暴ú暴ǔ暴ù暴ǖ暴┅⒈并镫溴姝骘蝽狒翦篝邀蝴艾超＾窿莠铂莠超铂莠船超铂莠惮船超铂┈邀辈┈眼骘蝽狒蕻蝴吵莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎炒蝴，，侈窿ěè暴ú暴ǔ暴ù暴ǖ暴┅⒋耽镫溴姝骘蝽狒翦篝邀蝴，，侈窿莠铂莠超铂莠船超铂莠惮船超铂┈邀吹┈眼骘蝽狒蕻蝴炒莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎车蝴超，＾窿ěè暴ú暴ǔ暴ù暴ǖ暴┅⒈并镫溴姝骘蝽狒翦篝邀蝴超，＾窿莠铂莠超铂莠船超铂莠惮船超铂┈邀辈┈眼骘蝽狒蕻蝴车莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎扯蝴，超＾窿ěè暴ú暴ǔ暴ù暴ǖ暴┅⒈泊耽镫溴姝骘蝽狒翦篝邀蝴，超＾窿莠铂莠超铂莠船超铂莠惮船超铂┈邀辈吹┈眼骘蝽狒蕻蝴扯莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎撤蝴，，＾窿ěè暴ú暴ǔ暴ù暴ǖ暴┅镫溴姝骘蝽狒翦篝邀蝴，，＾窿莠铂莠超铂莠船超铂莠惮船超铂┈邀┈眼骘蝽狒蕻蝴撤莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎掣蝴爆霈鲛窿ěè＼铋癌┅阿镫溴姝骘蝽狒翦篝邀蝴爆霈鲛窿邀猃伍飕┈邀┈眼骘蝽狒蕻蝴掣莼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻芎彻蝴霈爆鲛窿ěè＼铋癌┅阿镫溴姝骘蝽狒翦篝邀蝴霈爆鲛窿邀猃伍飕┈邀褒┈眼骘蝽狒蕻蝴彻莼眼鏖翳蝴莼篚怍弩被｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻利利窿窿" (1 2 3 4 5) "X 1 Y 2 X 3 Y 4 X 5")
	# 
	ok def-format-test(
		Q{@{X A^ Y A^ }},
		( [ 1, 2, 3, 4, 5 ] ),
		Q{X 1 Y 2 X 3 Y 4 X 5}
	), Q[format.^.@{.1];
	)

	#`(
	# (def-format-test format.^.@{.2
	#   "@{X A^ Y A^ }" (1 2 3 4) "X 1 Y 2 X 3 Y 4")
	# 
	ok def-format-test(
		Q{@{X A^ Y A^ }}, ( [ 1, 2, 3, 4 ] ), Q{X 1 Y 2 X 3 Y 4}
	), Q[format.^.@{.2];
	)

	#`(
	# (def-format-test format.^.@{.3
	#   "1@{A^A}" (1) "1")
	# 
	ok def-format-test( Q{1@{A^A}}, ( 1 ), Q{1} ), Q[format.^@{.3];
	)

	#`(
	# (def-format-test format.^.@{.4
	#   "0@{A^A}" (1) "" 1)
	# 
	ok def-format-test( Q{0@{A^A}}, ( 1 ), Q{}, 1 ), Q[format.^@{.4];
	)

	#`(
	# (def-format-test format.^.@{.5
	#   "1@{A^A}" (1 2 3) "12" 1)
	# 
	ok def-format-test(
		Q{1@{A^A}}, ( 1, 2, 3 ), Q{12}, 1
	), Q[format.^@{.5];
	)

	#`(
	# (def-format-test format.^.@{.6
	#   "@{AA0^A}" (1 2 3 4 5 6) "12" 4)
	# 
	ok def-format-test(
		Q{@{AA0^A}}, ( 1, 2, 3, 4, 5, 6 ), Q{12}, 4
	), Q[format.^@{.6];
	)

	#`(
	# (def-format-test format.^.@{.7
	#   "@{AAv^A}" (1 2 3 4 5 6 0 7 8 9 10 11 12) "12456" 6)
	# 
	ok def-format-test(
		Q{@{AAv^A}},
		( 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12 ),
		Q{12456},
		6
	), Q[format.^.@{.7];
	)

	#`(
	# (def-format-test format.^.@{.8
	#   "@{#,3^A}" (1 2 3 4 5 6 7 8 9 10) "1234567" 3)
	# 
	ok def-format-test(
		Q{@{#,3^A}},
		( 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ),
		Q{1234567},
		3
	), Q[format.^.@{.8];
	)

	#`(
	# (def-format-test format.^.@{.9
	#   "@{2,#^A}XA" (1 2 3 4 5 6 7 8 9 10) "12345678X9" 1)
	# 
	ok def-format-test(
		Q{@{2,#^A}XA},
		( 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ),
		Q{12345678X9},
		1
	), Q[format.^.@{.9];
	)

	#`(
	# (def-format-test format.^.@{.10
	#   "@{#,#^A}" (1 2 3 4 5 6 7 8 9 10) "" 10)
	# 
	ok def-format-test(
		Q{@{#,#^A}},
		( 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ),
		Q{1234567},
		10
	), Q[format.^.@{.10];
	)

	#`(
	# (def-format-test format.^.@{.11
	#   "@{#,#,#^A}" (1 2 3 4 5 6 7 8 9 10) "" 10)
	# 
	ok def-format-test(
		Q{@{#,#,#^A}}, ( 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ), Q{}, 10
	), Q[format.^.@{.11];
	)

	#`(
	# (def-format-test format.^.@{.12
	#   "@{#,1,2^A}" (1 2 3 4 5 6 7 8 9 10) "123456789" 1)
	# 
	ok def-format-test(
		Q{@{#,1,2^A}},
		( 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ),
		Q{123456789},
		1
	), Q[format.^.@{.12];
	)

	#`(
	# (def-format-test format.^.@{.13
	#   "@{#,#,v^A}" (1 2 3 4 5 6 7 8 9 10) "246" 3)
	# 
	ok def-format-test(
		Q{@{#,#,v^A}}, ( 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ), Q{246}, 3
	), Q[format.^.@{.13];
	)

	#`(
	# (def-format-test format.^.@{.14
	#   "@{#,#,v^A}" (1 2 3 4 5 6 7 8 9 10 11) "246" 4)
	# 
	ok def-format-test(
		Q{@{#,#,v^A}},
		( 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11 ),
		Q{246},
		4
	), Q[format.^.@{.14];
	)

	#`(
	# (def-format-test format.^.@{.15
	#   "@{#,#,v^A}" (1 2 3 4 5 6 7 8 9 10 11 12) "246" 5)
	# 
	ok def-format-test(
		Q{@{#,#,v^A}},
		( 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12 ),
		Q{246},
		5
	), Q[format.^.@{.15];
	)

	#`(
	# (def-format-test format.^.@{.16
	#   "@{#,#,v^A}" (1 2 3 4 5 6 7 8 9 10 11 12 13) "246" 6)
	# 
	ok def-format-test(
		Q{@{#,#,v^A}},
		( 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13 ),
		Q{246},
		6
	), Q[format.^.@{.16];
	)

	#`(
	# (def-format-test format.^.@{.17
	#   "@{#,#,v^A}" (1 2 3 4 5 6 7 8 9 10 11 12 13 14) "2468" 5)
	# 
	ok def-format-test(
		Q{@{#,#,v^A}},
		( 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14 ),
		Q{2468},
		5
	), Q[format.^.@{.17];
	)

	# (def-format-test format.^.@{.18
	#   "@{v,v^A}"
	#   ((1+ most-positive-fixnum)
	#    (1+ most-positive-fixnum)
	#    1)
	#   "" 1)
	# 
	# XXX Don't think it's applicable?

	# (def-format-test format.^.@{.19
	#   "@{0,v,v^A}"
	#   ((1+ most-positive-fixnum)
	#    (1+ most-positive-fixnum)
	#    1)
	#   "" 1)
	# 
	# XXX Don't think it's applicable?

	# (def-format-test format.^.@{.20
	#   "@{0,v,v^A}"
	#   ((1+ most-positive-fixnum)
	#    most-positive-fixnum
	#    1)
	#   "1")
	# 
	# XXX Don't think it's applicable?

	#`(
	# (def-format-test format.^.@{.21
	#   "@{1,v^A}" (nil 8 nil 7 0 6 1 5) "876" 1)
	# 
	ok def-format-test(
		Q{@{1,v^A}}, ( Nil, 8, Nil, 7, 0, 6, 1, 5 ), Q{876}, 1
	), Q[format.^.@{.21];
	)

	#`(
	# (def-format-test format.^.@{.22
	#   "@{0,v^A}" (3 8 1 7 3 6 nil 5) "876" 1)
	# 
	ok def-format-test(
		Q{@{0,v^A}}, ( 3, 8, 1, 7, 3, 6, Nil, 5 ), Q{876}, 1
	), Q[format.^.@{.22];
	)

	#`(
	# (def-format-test format.^.@{.23
	#   "@{1,2,v^A}" (0 1 0 2 0 3 3 4) "123" 1)
	# 
	ok def-format-test(
		Q{@{1,2,v^A}}, ( 0, 1, 0, 2, 0, 3, 3, 4 ), Q{123}, 1
	), Q[format.^.@{.23];
	)

	#`(
	# (def-format-test format.^.@{.24
	#   "@{1,2,v^A}" (0 1 0 2 0 3 nil 4) "1234")
	# 
	ok def-format-test(
		Q{@{1,2,v^A}}, ( 0, 1, 0, 2, 0, 3, Nil, 4 ), Q{1234}
	), Q[format.^.@{.24];
	)

	#`(
	# (def-format-test format.^.@{.25
	#   "@{1,1,v^A}" (0 1 0 2 0 3 nil 4) "123" 1)
	# 
	ok def-format-test(
		Q{@{1,1,v^A}}, ( 0, 1, 0, 2, 0, 3, Nil, 4 ), Q{123}, 1
	), Q[format.^.@{.25];
	)

	#`(
	# (def-format-test format.^.@{.26
	#   "@{'X^A}" (1 2 3) "123")
	# 
	ok def-format-test(
		Q{@{'X^A}}, ( 1, 2, 3 ), Q{123}
	), Q[format.^.@{.26];
	)

	#`(
	# (def-format-test format.^.@{.27
	#   "@{v,'X^A}" (0 1 #\x 2 nil 3 #\X 4 0 5) "123" 3)
	# 
	ok def-format-test(
		Q{@{v,'X^A}},
		( 0, 1, Q{x}, 2, Nil, 3, Q{X}, 4, 0, 5 ),
		Q{123},
		3
	), Q[format.^.@{.27];
	)

	#`(
	# (def-format-test format.^.@{.28
	#   "@{'X,v^A}" (0 1 #\x 2 nil 3 #\X 4 0 5) "123" 3)
	# 
	ok def-format-test(
		Q{@{'X,v^A}},
		( 0, 1, Q{x}, 2, Nil, 3, Q{X}, 4, 0, 5 ),
		Q{123},
		3
	), Q[format.^.@{.28];
	)

	#`(
	# (def-format-test format.^.@{.29
	#   "@{v,v^A}" (0 2 1 #\x #\X 2 5 #\X 3 #\y #\y 4 1 2 5) "123" 4) 
	# 
	ok def-format-test(
		Q{@{v,v^A}},
		( 0, 2, 1, Q{x}, Q{X}, 2, 5, Q{X}, 3, Q{y}, Q{y}, 4, 1, 2, 5 ),
		Q{123},
		4
	), Q[format.^.@{.29];
	)

	#`(
	# (def-format-test format.^.@{.30
	#   "@{',,',^A}" (1 2 3) "" 3)
	# 
	ok def-format-test(
		Q{@{',,',^A}}, ( 1, 2, 3 ), Q{}, 3
	), Q[format.^.@{.30];
	)

	#`(
	# (def-format-test format.^.@{.31
	#   "@{1,v,v^A}" (#\a nil 0) "0")
	# 
	ok def-format-test(
		Q{@{1,v,v^A}}, ( Q{a}, Nil, 0 ), Q{0}
	), Q[format.^.@{.31];
	)

	#`(
	# (def-format-test format.^.@{.32
	#   "@{v,1,v^A}" (#\a nil 0) "0")
	# 
	ok def-format-test(
		Q{@{v,1,v^A}}, ( Q{a}, Nil, 0 ), Q{0}
	), Q[format.^.@{.32];
	)

	#`(
	# (def-format-test format.^.@{.33
	#   "@{v,v,v^A}" (#\a #\a nil 0) "" 1)
	# 
	ok def-format-test(
		Q{@{v,v,v^A}}, ( Q{a}, Q{a}, Nil, 0 ), Q{}, 1
	), Q[format.^.@{.33];
	)
}, Q[Tests of ^ inside @{ ... }];

subtest {
	1;
	#`(
	# (def-format-test format.^.\:@{.1
	#   ":@{A^AA}" ('(1) '(2 3 4) '(5 6 7 8)) "1234567")
	# 
	ok def-format-test(
		Q{:@{A^AA}},
		( [ 1 ], [ 2, 3, 4 ], [ 5, 6, 7, 8 ] ),
		Q{1234567}
	), Q[format.^.:@{.1];
	)

	#`(
	# (def-format-test format.^.\:@{.2
	#   "@:{A0^AA}" ('(1) '(2 3 4) '(5 6 7 8)) "125")
	# 
	ok def-format-test(
		Q{:@{A0^AA}},
		( [ 1 ], [ 2, 3, 4 ], [ 5, 6, 7, 8 ] ),
		Q{125}
	), Q[format.^.:@{.2];
	)

	#`(
	# (def-format-test format.^.\:@{.3
	#   ":@{#^A}" ('(1) '(2 3 4) () '(5 6 7 8) ()) "125")
	# 
	ok def-format-test(
		Q{:@{#^A}},
		( [ 1 ], [ 2, 3, 4 ], [ ], [ 5, 6, 7, 8 ], [ ] ),
	), Q{125}, Q[format.^.:@{.3];
	)

	#`(
	# (def-format-test format.^.\:@{.4
	#   "@:{#^A#^A#^A#^A}" ('(1) '(2 3 4) () '(5 6 7 8) ()) "12345678")
	# 
	ok def-format-test(
		Q{@:{#^A#^A#^A#^A}},
		( [ 1 ], [ 2, 3, 4 ], [ ], [ 5, 6, 7, 8 ], [ ] ),
		Q{12345678}
	), Q[format.^.:@{.4];
	)

	#`(
	# (def-format-test format.^.\:@{.5
	#   ":@{v^A}" ('(1 2 3) '(0) '(2 4) '(0 5) '(1 6 7 8)) "246")
	# 
	ok def-format-test(
		Q{:@{v^A}},
		( [ 1, 2, 3 ], [ 0 ], [ 2, 4 ], [ 0, 5 ], [ 1, 6, 7, 8 ] ),
		Q{246}
	), Q[format.^.:@{.5];
	)

	#`(
	# (def-format-test format.^.\:@{.6
	#   ":@{v^A}" ('(nil) '(nil 1) '(1 2)) "12")
	# 
	ok def-format-test(
		Q{:@{v^A}}, ( [ Nil ], [ Nil, 1 ], [ 1, 2 ] ), Q{12}
	), Q[format.^.:@{.6];
	)

	#`(
	# (def-format-test format.^.\:@{.7
	#   ":@{v^A}" ('(#\x 1) '(#\y 2) '(0 3) '(1 4)) "124")
	# 
	ok def-format-test(
		Q{:@{v^A}},
		( [ Q{x}, 1 ], [ Q{y}, 2 ], [ 0, 3 ], [ 1, 4 ] ),
		Q{124}
	), Q[format.^.:@{.7];
	)

	#`(
	# (def-format-test format.^.\:@{.8
	#   ":@{v,3^A}" ('(1 1) '(2 0) '(3 4) '(5 6)) "106")
	# 
	ok def-format-test(
		Q{:@{v,3^A}},
		( [ 1, 1 ], [ 2, 0 ], [ 3, 4 ], [ 5, 6 ] ),
		Q{106}
	), Q[format.^.:@{.8];
	)

	#`(
	# (def-format-test format.^.\:@{.9
	#   "@:{3,v^A}" ('(1 1) '(2 0) '(3 4) '(5 6)) "106")
	# 
	ok def-format-test(
		Q{@:{3,v^A}},
		( [ 1, 1 ], [ 2, 0 ], [ 3, 4 ], [ 5, 6 ] ),
		Q{106}
	), Q[format.^.:@{.9];
	)

	#`(
	# (def-format-test format.^.\:@{.10
	#   ":@{v,3^A}" ('(#\x 1)) "1")
	# 
	ok def-format-test(
		Q{:@{v,3^A}}, ( [ Q{x}, 1 ] ), Q{1}
	), Q[format.^.:@{.10];
	)

	#`(
	# (def-format-test format.^.\:@{.11
	#   ":@{2,v^A}" ('(#\x 1)) "1")
	# 
	ok def-format-test(
		Q{:@{2,v^A}}, ( [ Q{x}, 1 ] ), Q{1}
	), Q[format.^.:@{.11];
	)

	#`(
	# (def-format-test format.^.\:@{.12
	#   ":@{v,v^A}" ('(1 2 0) '(0 1 1) '(1 0 2) '(3 3 5) '(4 5 6)) "0126")
	# 
	ok def-format-test(
		Q{:@{v,v^A}},
		( [ 1, 2, 0 ], [ 0, 1, 1 ], [ 1, 0, 2 ],
		  [ 3, 3, 5 ], [ 4, 5, 6 ] ),
		Q{0126}
	), Q[format.^.:@{.12];
	)

	#`(
	# (def-format-test format.^.\:@{.13
	#   ":@{v,v^A}" ('(1 2 0) '(#\a #\A 1) '(#\A #\A 2) '(1 2 3)) "013")
	# 
	ok def-format-test(
		Q{:@{v,v^A}},
		( [ 1, 2, 0 ], [ Q{a}, Q{A}, 1 ],
		  [ Q{A}, Q{A}, 2 ], [ 1, 2, 3 ] ),
		Q{013}
	), Q[format.^.:@{.13];
	)

	#`(
	# (def-format-test format.^.\:@{.14
	#   ":@{'x,3^A}" ('(1)) "1")
	# 
	ok def-format-test(
		Q{:@{'x,3^A}}, ( [ 1 ] ), Q{1}
	), Q[format.^.:@{.14];
	)

	#`(
	# (def-format-test format.^.\:@{.15
	#   ":@{3,'x^A}" ('(1)) "1")
	# 
	ok def-format-test(
		Q{:@{3,'x^A}}, ( [ 1 ] ), Q{1}
	), Q[format.^.:@{.15];
	)

	#`(
	# (def-format-test format.^.\:@{.16
	#   ":@{'x,'x^A}" ('(1)) "")
	# 
	ok def-format-test(
		Q{:@{'x,'x^A}}, ( [ 1 ] ), Q{}
	), Q[format.^.:@{.16];
	)

	#`(
	# (def-format-test format.^.\:@{.17
	#   ":@{#,1^A}" ('(1) '(2 10) '(3 a b) '(4) '(5 x) '(6) '(7 8)) "2357")
	# 
	ok def-format-test(
		Q{:@{#,1^A}},
		( [ 1 ], [ 2, 10 ], [ 3, Q{a}, Q{b} ],
		  [ 4 ], [ 5, Q{x} ], [ 6 ], [ 7, 8 ] ),
		Q{2357}
	), Q[format.^.:@{.17];
	)

	#`(
	# (def-format-test format.^.\:@{.18
	#   ":@{1,#^A}" ('(1) '(2 10) '(3 a b) '(4) '(5 x) '(6) '(7 8)) "2357")
	# 
	ok def-format-test(
		Q{:@{1,#^A}},
		( [ 1 ], [ 2, 10 ], [ 3, Q{a}, Q{b} ],
		  [ 4 ], [ 5, Q{x} ], [ 6 ], [ 7, 8 ] ),
		Q{2357}
	), Q[format.^.:@{.18];
	)

	#`(
	# (def-format-test format.^.\:@{.19
	#   ":@{#,#^A}" ('(1) '() '(2 10) '(3 a b) '(4) '(5 x) '(6) '(7 8)) "")
	# 
	ok def-format-test(
		Q{:@{#,#^A}},
		( [ 1 ], [ ], [ 2, 10 ], [ 3, Q{a}, Q{b} ], [ 4 ],
		  [ 5, Q{x} ], [ 6 ], [ 7, 8 ] ),
		Q{}
	), Q[format.^.:@{.19];
	)

	#`(
	# (def-format-test format.^.\:@{.20
	#   ":@{0,v^A}" ('(0 1) '(1 2) '(nil 3) '(2 4)) "24")
	# 
	ok def-format-test(
		Q{:@{0,v^A}},
		( [ 0, 1 ], [ 1, 2 ], [ Nil, 3 ], [ 2, 4 ] ),
		Q{24}
	), Q[format.^.:@{.20];
	)

	#`(
	# (def-format-test format.^.\:@{.21
	#   ":@{1,v^A}" ('(0 1) '(1 2) '(nil 3) '(2 4)) "134")
	# 
	ok def-format-test(
		Q{:@{1,v^A}},
		( [ 0, 1 ], [ 1, 2 ], [ Nil, 3 ], [ 2, 4 ] ),
		Q{134}
	), Q[format.^.:@{.21];
	)

	#`(
	# (def-format-test format.^.\:@{.22
	#   ":@{1,1,1^A}" ('(1) '(2 3) '(4 5 6) '(7 8 9 0)) "")
	# 
	ok def-format-test(
		Q{:@{1,1,1^A}},
		( [ 1 ], [ 2, 3 ], [ 4, 5, 6 ], [ 7, 8, 9, 0 ] ),
		Q{}
	), Q[format.^.:@{.22];
	)

	#`(
	# (def-format-test format.^.\:@{.23
	#   ":@{1,2,3^A}" ('(1) '(2 3) '(4 5 6) '(7 8 9 0)) "")
	# 
	ok def-format-test(
		Q{:@{1,2,3^A}},
		( [ 1 ], [ 2, 3 ], [ 4, 5, 6 ], [ 7, 8, 9, 0 ] ),
		Q{}
	), Q[format.^.:@{.23];
	)

	#`(
	# (def-format-test format.^.\:@{.24
	#   ":@{1,2,1^A}" ('(1) '(2 3) '(4 5 6) '(7 8 9 0)) "1247")
	# 
	ok def-format-test(
		Q{:@{1,2,1^A}},
		( [ 1 ], [ 2, 3 ], [ 4, 5, 6 ], [ 7, 8, 9, 0 ] ),
		Q{1247}
	), Q[format.^.:@{.24];
	)

	#`(
	# (def-format-test format.^.\:@{.25
	#   ":@{1,0,1^A}" ('(1) '(2 3) '(4 5 6) '(7 8 9 0)) "1247")
	# 
	ok def-format-test(
		Q{:@{1,0,1^A}},
		( [ 1 ], [ 2, 3 ], [ 4, 5, 6 ], [ 7, 8, 9, 0 ] ),
		Q{1247}
	), Q[format.^.:@{.25];
	)

	#`(
	# (def-format-test format.^.\:@{.26
	#   ":@{3,2,1^A}" ('(1) '(2 3) '(4 5 6) '(7 8 9 0)) "1247")
	# 
	ok def-format-test(
		Q{:@{3,2,1^A}},
		( [ 1 ], [ 2, 3 ], [ 4, 5, 6 ], [ 7, 8, 9, 0 ] ),
		Q{1247}
	), Q[format.^.:@{.26];
	)

	#`(
	# (def-format-test format.^.\:@{.27
	#   ":@{v,2,3^A}" ('(1 10) '(2 20) '(3 30) '(4 40)) "3040")
	# 
	ok def-format-test(
		Q{:@{v,2,3^A}},
		( [ 1, 10 ], [ 2, 20 ], [ 3, 30 ], [ 4, 40 ] ),
		Q{3040}
	), Q[format.^.:@{.27];
	)

	#`(
	# (def-format-test format.^.\:@{.28
	#   ":@{1,v,3^A}" ('(0 7) '(1 10) '(2 20) '(3 30) '(4 40)) "740")
	# 
	ok def-format-test(
		Q{:@{1,v,3^A}},
		( [ 0, 7 ], [ 1, 10 ], [ 2, 20 ], [ 3, 30 ], [ 4, 40 ] ),
		Q{740}
	), Q[format.^.:@{.28];
	)

	#`(
	# (def-format-test format.^.\:@{.29
	#   ":@{1,2,v^A}" ('(0 0) '(1 10) '(2 20) '(3 30) '(4 40) '(0 50))
	#   "01050")
	# 
	ok def-format-test(
		Q{:@{1,2,v^A}},
		( [ 0, 0 ], [ 1, 10 ], [ 2, 20 ],
		  [ 3, 30 ], [ 4, 40 ], [ 0, 50 ] ),
		Q{01050}
	), Q[format.^.:@{.29];
	)

	#`(
	# (def-format-test format.^.\:@{.30
	#   ":@{1,2,v^A}" ('(nil 0)) "0")
	# 
	ok def-format-test(
		Q{:@{1,2,v^A}}, ( [ Nil, 0 ] ), Q{0}
	), Q[format.^.:@{.30];
	)

	#`(
	# (def-format-test format.^.\:@{.31
	#   ":@{#,3,3^A}" ('(1) '(2 1) '(3 2 1) '(4 3 2 1) '(5 4 3 2 1)) "45")
	# 
	ok def-format-test(
		Q{:@{#,3,3^A}},
		( [ 1 ], [ 2, 1 ], [ 3, 2, 1 ], [ 4, 3, 2, 1 ],
		  [ 5, 4, 3, 2, 1 ] ),
		Q{45}
	), Q[format.^.:@{.31];
	)

	#`(
	# (def-format-test format.^.\:@{.32
	#   ":@{2,#,3^A}" ('(1) '(2 1) '(3 2 1) '(4 3 2 1) '(5 4 3 2 1)) "145")
	# 
	ok def-format-test(
		Q{:@{2,#,3^A}},
		( [ 1 ], [ 2, 1 ], [ 3, 2, 1 ], [ 4, 3, 2, 1 ],
		  [ 5, 4, 3, 2, 1 ] ),
		Q{145}
	), Q[format.^.:@{.32];
	)

	#`(
	# (def-format-test format.^.\:@{.33
	#   ":@{0,3,#^A}" ('(1) '(2 1) '(3 2 1) '(4 3 2 1) '(5 4 3 2 1)) "12")
	# 
	ok def-format-test(
		Q{:@{0,3,#^A}},
		( [ 1 ], [ 2, 1 ], [ 3, 2, 1 ], [ 4, 3, 2, 1 ],
		  [ 5, 4, 3, 2, 1 ] ),
		Q{12}
	), Q[format.^.:@{.33];
	)

	#`(
	# (def-format-test format.^.\:@{.34
	#   ":@{#,#,3^A}" ('(1) '(2 1) '(3 2 1) '(4 3 2 1) '(5 4 3 2 1)) "45")
	# 
	ok def-format-test(
		Q{:@{#,#,3^A}},
		( [ 1 ], [ 2, 1 ], [ 3, 2, 1 ], [ 4, 3, 2, 1 ],
		  [ 5, 4, 3, 2, 1 ] ),
		Q{45}
	), Q[format.^.:@{.34];
	)

	#`(
	# (def-format-test format.^.\:@{.35
	#   ":@{3,#,#^A}" ('(1) '(2 1) '(3 2 1) '(4 3 2 1) '(5 4 3 2 1)) "12")
	# 
	ok def-format-test(
		Q{:@{3,#,#^A}},
		( [ 1 ], [ 2, 1 ], [ 3, 2, 1 ], [ 4, 3, 2, 1 ],
		  [ 5, 4, 3, 2, 1 ] ),
		Q{12}
	), Q[format.^.:@{.35];
	)

	#`(
	# (def-format-test format.^.\:@{.36
	#   ":@{#,3,#^A}" ('(1) '(2 1) '(3 2 1) '(4 3 2 1) '(5 4 3 2 1)) "1245")
	# 
	ok def-format-test(
		Q{:@{#,3,#^A}},
		( [ 1 ], [ 2, 1 ], [ 3, 2, 1 ], [ 4, 3, 2, 1 ],
		  [ 5, 4, 3, 2, 1 ] ),
		Q{1245}
	), Q[format.^.:@{.36];
	)

	#`(
	# (def-format-test format.^.\:@{.37
	#   ":@{#,#,#^A}" ('(1) '(2 1) '(3 2 1) '(4 3 2 1) '(5 4 3 2 1)) "")
	# 
	ok def-format-test(
		Q{:@{#,#,#^A}},
		( [ 1 ], [ 2, 1 ], [ 3, 2, 1 ], [ 4, 3, 2, 1 ],
		  [ 5, 4, 3, 2, 1 ] ),
		Q{}
	), Q[format.^.:@{.37];
	)

	#`(
	# (def-format-test format.^.\:@{.38
	#   ":@{1,v,v^A}" ('(#\a nil 0)) "0")
	# 
	ok def-format-test(
		Q{:@{1,v,v^A}}, ( [ Q{a}, Nil, 0 ] ), Q{0}
	), Q[format.^.:@{.38];
	)

	#`(
	# (def-format-test format.^.\:@{.39
	#   ":@{v,1,v^A}" ('(#\a nil 0)) "0")
	# 
	ok def-format-test(
		Q{:@{v,1,v^A}}, ( [ Q{a}, Nil, 0 ] ), Q{0}
	), Q[format.^.:@{.39];
	)
}, Q[Inside :@{];

subtest {
	1;
	#`(
	# (def-format-test format.\:^.\:{.1
	#   ":{:^A}"  (nil) "")
	# 
	ok def-format-test( Q{:{:^A}}, ( Nil ), Q{} ), Q[format.:^.:{.1];
	)

	#`(
	# (def-format-test format.\:^.\:{.2
	#   "(:{A:^,})"  ('((1)(2)(3))) "(1,2,3)")
	# 
	ok def-format-test(
		Q{:{A:^,}}, ( [ [ 1 ], [ 2 ], [ 3 ] ] ), Q{(1,2,3)}
	), Q[format.:^.:{.2];
	)

	#`(
	# (def-format-test format.\:^.\:{.3
	#   ":{:^A}"  ('((1)(2)(3)(4))) "123")
	# 
	ok def-format-test(
		Q{:{:^A}}, ( [ [ 1 ], [ 2 ], [ 3 ], [ 4 ] ] ), Q{123}
	), Q[format.:^.:{.3];
	)
}, Q[:^ in :{];

subtest {
	1;
	#`(
	# (def-format-test format.\:^.\:{.4
	#   ":{0:^A}" ('((1)(2))) "")
	# 
	ok def-format-test(
		Q{:{0:^A}}, ( [ [ 1 ], [ 2 ] ] ), Q{}
	), Q[format.:^.:{.4];
	)

	#`(
	# (def-format-test format.\:^.\:{.5
	#   ":{1:^A}" ('((1)(2))) "12")
	# 
	ok def-format-test(
		Q{:{1:^A}}, ( [ [ 1 ], [ 2 ] ] ), Q{12}
	), Q[format.:^.:{.5];
	)

	#`(
	# (def-format-test format.\:^.\:{.6
	#   ":{'X:^A}" ('((1)(2))) "12")
	# 
	ok def-format-test(
		Q{:{'X:^A}}, ( [ [ 1 ], [ 2 ] ] ), Q{12}
	), Q[format.:^.:{.6];
	)

	#`(
	# (def-format-test format.\:^.\:{.7
	#   ":{v:^A}" ('((1 8)(2 3 4)(3 1)(0)(6 7)(8 10))) "831")
	# 
	ok def-format-test(
		Q{:{v:^A}},
		( [ [ 1, 8 ], [ 2, 3, 4 ], [ 3, 1 ],
		    [ 0 ], [ 6, 7 ], [ 8, 10 ] ] ),
		Q{831}
	), Q[format.:^.:{.7];
	)

	#`(
	# (def-format-test format.\:^.\:{.8
	#   ":{V:^A}" ('((#\X 1)(0 2))) "1")
	# 
	ok def-format-test(
		Q{:{V:^A}}, ( [ [ Q{X}, 1 ], [ 0, 2 ] ] ), Q{1}
	), Q[format.:^.:{.8];
	)

	#`(
	# (def-format-test format.\:^.\:{.9
	#   ":{#:^A}" ('((1)(2)(3 4)(5 6 7)()(8 9 10))) "1235")
	# 
	ok def-format-test(
		Q{:{#:^A}},
		( [ [ 1 ], [ 2 ], [ 3, 4 ], [ 5, 6, 7 ], [ ], [ 8, 9, 10 ] ] ),
		Q{1}
	), Q[format.:^.:{.9];)

	#`(
	# (def-format-test format.\:^.\:{.10
	#   ":{1,1:^A}" ('(()(1)(2 3))) "")
	# 
	ok def-format-test(
		Q{:{1,1:^A}}, ( [ [ ], [ 1 ] , [ 2, 3 ] ] ), Q{}
	), Q[format.:^.:{.10];
	)

	#`(
	# (def-format-test format.\:^.\:{.11
	#   ":{0,1:^A}" ('((1)(2 3))) "12")
	# 
	ok def-format-test(
		Q{:{0,1:^A}}, ( [ [ 1 ], [ 2, 3 ] ] ), Q{12}
	), Q[format.:^.:{.11];
	)

	#`(
	# (def-format-test format.\:^.\:{.12
	#   ":{v,1:^A}" ('((2 3)(4 5 6)(0 2)(1 7)(9 10))) "352")
	# 
	ok def-format-test(
		Q{:{v,1:^A}},
		( [ [ 2, 3 ], [ 4, 5, 6 ], [ 0, 2 ], [ 1, 7 ], [ 9, 10 ] ] ),
		Q{352}
	), Q[format.:^.:{.12];
	)

	#`(
	# (def-format-test format.\:^.\:{.13
	#   ":{1,V:^A}" ('((2 3)(4 5 6)(0 2)(1 7)(9 10))) "352")
	# 
	ok def-format-test(
		Q{:{1,V:^A}},
		( [ [ 2, 3 ], [ 4, 5, 6 ], [ 0, 2 ], [ 1, 7 ], [ 9, 10 ] ] ),
		Q{352}
	), Q[format.:^.:{.13];
	)

	#`(
	# (def-format-test format.\:^.\:{.14
	#   ":{V,v:^A}" ('((0 1 2) (1 0 3) (4 4) () (5 6 7))) "23")
	# 
	ok def-format-test(
		Q{:{V,v:^A}},
		( [ [ 0, 1, 2 ], [ 1, 0, 3 ], [ 4, 4 ], [ ], [ 5, 6, 7 ] ] ),
		Q{352}
	), Q[format.:^.:{.14];
	)

	#`(
	# (def-format-test format.\:^.\:{.15
	#   ":{#,1:^A}" ('((2 3 4)(4 5)(0)(1 7)(9 10)))
	#   "24")
	# 
	ok def-format-test(
		Q{:{#,1:^A}},
		( [ [ 2, 3, 4 ], [ 4, 5 ], [ 0 ], [ 1, 7 ], [ 9, 10 ] ] ),
		Q{24}
	), Q[format.:^.:{.15];
	)

	#`(
	# (def-format-test format.\:^.\:{.16
	#   ":{1,#:^A}" ('((2 3 4)(4 5)(0)(1 7)(9 10)))
	#   "24")
	# 
	ok def-format-test(
		Q{:{1,#:^A}},
		( [ [ 2, 3, 4 ], [ 4, 5 ], [ 0 ], [ 1, 7 ], [ 9, 10 ] ] ),
		Q{24}
	), Q[format.:^.:{.16];
	)

	#`(
	# (def-format-test format.\:^.\:{.17
	#   ":{#,#:^A}" ('(nil))
	#   "")
	# 
	ok def-format-test(
		Q{:{#,#:^A}}, ( [ Nil ] ), Q{24}
	), Q[format.:^.:{.17];
	)

	#`(
	# (def-format-test format.\:^.\:{.18
	#   ":{#,#:^A}" ('((1)))
	#   "")
	# 
	ok def-format-test(
		Q{:{#,#:^A}}, ( [ [ 1 ] ] ), Q{}
	), Q[format.:^.:{.18];
	)

	#`(
	# (def-format-test format.\:^.\:{.19
	#   ":{#,v:^A}" ('((1 2)(3 4)(2 5 6)(1)(2)))
	#   "245")
	# 
	ok def-format-test(
		Q{:{#,v:^A}},
		( [ [ 1, 2 ], [ 3, 4 ], [ 2, 5, 6 ], [ 1 ], [ 2 ] ] ),
		Q{24}
	), Q[format.:^.:{.19];
	)

	#`(
	# (def-format-test format.\:^.\:{.20
	#   ":{V,#:^A}" ('((0 2)(1 3 4)(1 3)()(0 7)))
	#   "23")
	# 
	ok def-format-test(
		Q{:{V,#:^A}},
		( [ [ 0, 2 ], [ 1, 3, 4 ], [ 1, 3 ], [ ], [ 0, 7 ] ] ),
		Q{23}
	), Q[format.:^.:{.20];
	)

	#`(
	# (def-format-test format.\:^.\:{.21
	#   ":{'X,'Y:^A}" ('((1)(2)))
	#   "12")
	# 
	ok def-format-test(
		Q{:{'X,'Y:^A}}, ( [ [ 1 ], [ 2 ] ] ), Q{23}
	), Q[format.:^.:{.21];
	)

	#`(
	# (def-format-test format.\:^.\:{.22
	#   ":{'X,'X:^A}" ('((1)(2)))
	#   "")
	# 
	ok def-format-test(
		Q{:{'X,'X:^A}}, ( [ [ 1 ], [ 2 ] ] ), Q{}
	), Q[format.:^.:{.22];
	)

	#`(
	# (def-format-test  format.\:^.\:{.23
	#   ":{1,2,3:^A}" ('((1)(2)))
	#   "")
	# 
	ok def-format-test(
		Q{:{1,2,3:^A}}, ( [ [ 1 ], [ 2 ] ] ), Q{}
	), Q[format.:^.:{.23];
	)

	#`(
	# (def-format-test  format.\:^.\:{.24
	#   ":{1,2,1:^A}" ('((1)(2)))
	#   "12")
	# 
	ok def-format-test(
		Q{:{1,2,2:^A}}, ( [ [ 1 ], [ 2 ] ] ), Q{12}
	), Q[format.:^.:{.24];
	)

	#`(
	# (def-format-test  format.\:^.\:{.25
	#   ":{2,1,3:^A}" ('((1)(2)))
	#   "12")
	# 
	ok def-format-test(
		Q{:{2,1,3:^A}}, ( [ [ 1 ], [ 2 ] ] ), Q{12}
	), Q[format.:^.:{.25];
	)

	#`(
	# (def-format-test  format.\:^.\:{.26
	#   ":{1,1,v:^A}" ('((0 4)(nil 1)(0 5)))
	#   "4")
	# 
	ok def-format-test(
		Q{:{1,1,v:^A}},
		( [ [ 0, 4 ], [ Nil, 1 ], [ 0, 5 ] ] ),
		Q{4}
	), Q[format.:^.:{.26];
	)

	#`(
	# (def-format-test  format.\:^.\:{.27
	#   ":{v,2,2:^A}" ('((3 4)(1 1)(4 5)))
	#   "4")
	# 
	ok def-format-test(
		Q{:{v,2,2:^A}}, ( [ [ 3, 4 ], [ 1, 1 ], [ 4, 5 ] ] ), Q{4}
	), Q[format.:^.:{.27];
	)

	#`(
	# (def-format-test  format.\:^.\:{.28
	#   ":{1,v,2:^A}" ('((0 2)(3 4)(1 1)(4 5)))
	#   "24")
	# 
	ok def-format-test(
		Q{:{1,v,2:^A}},
		( [ [ 0, 2 ], [ 3, 4 ], [ 1, 1 ], [ 4, 5 ] ] ),
		Q{24}
	), Q[format.:^.:{.28];
	)

	#`(
	# (def-format-test  format.\:^.\:{.29
	#   ":{V,v,3:^A}" ('((1 4 0)(2 1 7)(4 4 8 0)(1 2 6)(9 8 0)))
	#   "078")
	# 
	ok def-format-test(
		Q{:{V,v,3:^A}},
		( [ [ 1, 4, 0 ], [ 2, 1, 7 ], [ 4, 4, 8, 0 ],
		    [ 1, 2, 6 ], [ 9, 8, 0 ] ] ),
		Q{078}
	), Q[format.:^.:{.29];
	)

	#`(
	# (def-format-test  format.\:^.\:{.30
	#   ":{v,2,v:^A}" ('((1 1 0)(3 2 5)(2 1 6)(1 2 0)(10 11 13)))
	#   "056")
	# 
	ok def-format-test(
		Q{:{v,2,v:^A}},
		( [ [ 1, 1, 0 ], [ 3, 2, 5 ], [ 2, 1, 6 ],
		    [ 1, 2, 0 ], [ 10, 11, 13 ] ] ),
		Q{056}
	), Q[format.:^.:{.30];
	)

	#`(
	# (def-format-test  format.\:^.\:{.31
	#   ":{2,V,v:^A}" ('((1 1 0)(3 2 5)(2 1 6)(10 11 13)(0 1 0)))
	#   "056")
	# 
	ok def-format-test(
		Q{:{2,V,v:^A}},
		( [ [ 1, 1, 0 ], [ 3, 2, 5 ], [ 2, 1, 6 ],
		    [ 10, 11, 13 ], [ 0, 1, 0 ] ] ),
		Q{056}
	), Q[format.:^.:{.31];
	)

	#`(
	# (def-format-test  format.\:^.\:{.32
	#   ":{v,v,V:^A}" ('((1 2 1 0)(2 1 1 4)(2 3 1 6)(1 2 3)(0 1 0 8)))
	#   "046")
	# 
	ok def-format-test(
		Q{:{v,v,V:^A}},
		( [ [ 1, 2, 1, 0 ], [ 2, 1, 1, 4 ], [ 2, 3, 1, 6 ],
		    [ 1, 2, 3 ], [ 0, 1, 0, 8 ] ] ),
		Q{046}
	), Q[format.:^.:{.32];
	)

	#`(
	# (def-format-test  format.\:^.\:{.33
	#   ":{#,2,2:^A}" ('((1 2 3)(2 X X)(0 A B C D)(4 5)(5 7 8 9)))
	#   "120")
	# 
	ok def-format-test(
		Q{:{#,2,2:^A}},
		( [ [ 1, 2, 3 ], [ 2, Q{X}, Q{X} ],
		    [ 0, Q{A}, Q{B}, Q{C}, Q{D} ],
		    [ 4, 5 ], [ 5, 7, 8, 9 ] ] ),
		Q{120}
	), Q[format.:^.:{.33];
	)
#`(
	# (def-format-test  format.\:^.\:{.34
	#   ":{2,#,3:^A}" ('((1)(2 3 4 5)(3 4)(4 5 6 7 8)()))
	#   "12")
	# 
	ok def-format-test(
		Q{:{2,#,3:^A}},
		( [ [ 1 ], [ 2, 3, 4, 5 ], [ 3, 4 ], [ 4, 5, 6, 7, 8 ], [ ] ] ),
		Q{12}
	), Q[format.:^.:{.34];
	)

	#`(
	# (def-format-test  format.\:^.\:{.35
	#   ":{1,3,#:^A}" ('((1)(2 3)(3 4)(4 5 6)(5)))
	#   "123")
	# 
	ok def-format-test(
		Q{:{1,3,#:^A}},
		( [ [ 1 ], [ 2, 3 ], [ 3, 4 ], [ 4, 5, 6 ], [ 5 ] ] ),
		Q{123}
	), Q[format.:^.:{.35];
	)

	#`(
	# (def-format-test  format.\:^.\:{.36
	#   ":{#,#,2:^A}" ('((1 2 3)(2 X X)(0 A B C D)(4 5)(5 7 8 9)))
	#   "120")
	# 
	ok def-format-test(
		Q{:{#,#,2:^A}},
		( [ [ 1, 2, 3 ], [ 2, Q{X}, Q{X} ],
		    [ 1, Q{A}, Q{B}, Q{C}, Q{D} ],
		    [ 4, 5 ], [ 5, 7, 8, 9 ] ] ),
		Q{120}
	), Q[format.:^.:{.36];
	)

	#`(
	# (def-format-test  format.\:^.\:{.37
	#   ":{3,#,#:^A}" ('((1)(2 3)(3 4)(4 5 6)(5)))
	#   "123")
	# 
	ok def-format-test(
		Q{:{3,#,#:^A}},
		( [ [ 1 ], [ 2, 3 ], [ 3, 4 ], [ 4, 5, 6 ], [ 5 ] ] ),
		Q{123}
	), Q[format.:^.:{.37];
	)

	#`(
	# (def-format-test  format.\:^.\:{.38
	#   ":{#,2,#:^A}" ('((1 2 3)(2)(0 A B C D)(4 5)(5 7 8 9)))
	#   "120")
	#  
	ok def-format-test(
		Q{:{#,2,#:^A}},
		( [ [ 1, 2, 3 ], [ 2 ], [ 0, Q{A}, Q{B}, Q{C}, Q{D} ],
		    [ 4, 5 ], [ 5, 7, 8, 9 ] ] ),
		Q{120}
	), Q[format.:^.:{.38];
	)

	#`(
	# (def-format-test  format.\:^.\:{.39
	#   ":{#,#,#:^A}" ('((1 2 3)(2)(0 A B C D)(4 5)(5 7 8 9)))
	#   "")
	# 
	ok def-format-test(
		Q{:{#,#,#:^A}},
		( [ [ 1, 2, 3 ], [ 2 ], [ 0, Q{A}, Q{B}, Q{C}, Q{D} ],
		    [ 4, 5 ], [ 5, 7, 8, 9 ] ] ),
		Q{}
	), Q[format.:^.:{.38];
	)
}, Q[arguments];

subtest {
	#`(
	# (def-format-test format.\:^.\:@{.1
	#   ":@{:^A}" nil "")
	# 
	ok def-format-test( Q{:@{:^A}}, ( ), Q{} ), Q[format.:^.:@{.1];
	)

	#`(
	# (def-format-test format.\:^.\:@{.2
	#   "(:@{A:^,})" ('(1) '(2) '(3))
	#   "(1,2,3)")
	# 
	ok def-format-test(
		Q{(:@{A:^,})}, ( [ 1 ], [ 2 ], [ 3 ] ), Q{(1,2,3)}
	), Q[format.:^.:@{.2];
	)

	#`(
	# (def-format-test format.\:^.\:@{.3
	#   ":@{:^A}" ('(1) '(2) '(3) '(4))
	#   "123")
	#
	ok def-format-test(
		Q{(:@{:^A})}, ( [ 1 ], [ 2 ], [ 3 ], [ 4 ] ), Q{123}
	), Q[format.:^.:@{.3];
	)

	#`(
	# (def-format-test format.\:^.\:@{.4
	#   ":@{0:^A}" ('(1) '(2))
	#   "" 1)
	# 
	ok def-format-test(
		Q{:@{0:^A}}, ( [ 1 ], [ 2 ] ), Q{}, 1
	), Q[format.:^.:@{.4];
	)

	#`(
	# (def-format-test format.\:^.\:@{.5
	#   ":@{1:^A}" ('(1) '(2))
	#   "12")
	# 
	ok def-format-test(
		Q{:@{1:^A}}, ( [ 1 ], [ 2 ] ), Q{12}
	), Q[format.:^.:@{.5];
	)

	#`(
	# (def-format-test format.\:^.\:@{.6
	#   ":@{'X:^A}" ('(1) '(2))
	#   "12")
	# 
	ok def-format-test(
		Q{:@{'X:^A}}, ( [ 1 ], [ 2 ] ), Q{12}
	), Q[format.:^.:@{.6];
	)

	#`(
	# (def-format-test format.\:^.\:@{.7
	#   ":@{v:^A}" ('(1 8) '(2 3 4) '(3 1) '(0) '(6 7) '(8 10))
	#   "831" 2)
	# 
	ok def-format-test(
		Q{:@{v:^A}},
		( [ 1, 8 ], [ 2, 3, 4 ], [ 3, 1 ], [ 0 ], [ 6, 7 ], [ 8, 10 ] ),
		Q{831},
		2
	), Q[format.:^.:@{.7];
	)

	#`(
	# (def-format-test format.\:^.\:@{.8
	#   ":@{V:^A}" ('(#\X 1) '(0 2))
	#   "1")
	# 
	ok def-format-test(
		Q{:@{V:^A}}, ( [ Q{X}, 1 ], [ 0, 2 ] ), Q{1}
	), Q[format.:^.:@{.8];
	)

	#`(
	# (def-format-test format.\:^.\:@{.9
	#   ":@{#:^A}" ('(1) '(2) '(3 4) '(5 6 7) () '(8 9 10))
	#   "1235" 1)
	# 
	ok def-format-test(
		Q{:@{#:^A}},
		( [ 1 ], [ 2 ], [ 3, 4 ], [ 5, 6, 7 ], [ ], [ 8, 9, 10 ] ),
		Q{1235},
		1
	), Q[format.:^.:@{.9];
	)

	# (def-format-test format.\:^.\:@{.10
	#   ":@{1,1:^A}" (() '(1) '(2 3))
	#   "" 2)
	# 
	ok def-format-test(
		Q{:@{1,1:^A}}, ( [ ], [ 1 ], [ 2, 3 ] ), Q{}, 2
	), Q[format.:^.:@{.10];

	#`(
	# (def-format-test format.\:^.\:@{.11
	#   ":@{0,1:^A}" ('(1) '(2 3))
	#   "12")
	# 
	ok def-format-test(
		Q{:@{0,1:^A}}, ( [ 1 ], [ 2, 3 ] ), Q{12}
	), Q[format.:^.:@{.11];
	)

	#`(
	# (def-format-test format.\:^.\:@{.12
	#   ":@{v,1:^A}" ('(2 3) '(4 5 6) '(0 2) '(1 7) '(9 10))
	#   "352" 1)
	# 
	ok def-format-test(
		Q{:@{v,1:^A}},
		( [ 2, 3 ], [ 4, 5, 6 ], [ 0, 2 ], [ 1, 7 ], [ 9, 10 ] ),
		Q{12},
		1
	), Q[format.:^.:@{.12];
	)

	#`(
	# (def-format-test format.\:^.\:@{.13
	#   ":@{1,V:^A}" ('(2 3) '(4 5 6) '(0 2) '(1 7) '(9 10))
	#   "352" 1)
	# 
	ok def-format-test(
		Q{:@{1,V:^A}},
		( [ 2, 3 ], [ 4, 5, 6 ], [ 0, 2 ], [ 1, 7 ], [ 9, 10 ] ),
		Q{352},
		1
	), Q[format.:^.:@{.13];
	)

	#`(
	# (def-format-test format.\:^.\:@{.14
	#   ":@{V,v:^A}" ('(0 1 2) '(1 0 3) '(4 4) () '(5 6 7))
	#   "23" 2)
	# 
	ok def-format-test(
		Q{:@{V,v:^A} },
		( [ 0, 1, 2 ], [ 1, 0, 3 ], [ 4, 4 ], [ ], [ 5, 6, 7 ] ),
		Q{352},
		2
	), Q[format.:^.:@{.14];
	)

	#`(
	# (def-format-test format.\:^.\:@{.15
	#   ":@{#,1:^A}" ('(2 3 4) '(4 5) '(0) '(1 7) '(9 10))
	#   "24" 2)
	# 
	ok def-format-test(
		Q{:@{#,1:^A}},
		( [ 2, 3, 4 ], [ 4, 5 ], [ 0 ], [ 1, 7 ], [ 9, 10 ] ),
		Q{24},
		2
	), Q[format.:^.:@{.15];
	)

	#`(
	# (def-format-test format.\:^.\:@{.16
	#   ":@{1,#:^A}" ('(2 3 4) '(4 5) '(0) '(1 7) '(9 10))
	#   "24" 2)
	# 
	ok def-format-test(
		Q{:@{1,#:^A}},
		( [ 2, 3, 4 ], [ 4, 5 ], [ 0 ], [ 1, 7 ], [ 9, 10 ] ),
		Q{24},
		2
	), Q[format.:^.:@{.16];
	)

	#`(
	# (def-format-test format.\:^.\:@{.17
	#   ":@{#,#:^A}" (nil)
	#   "")
	# 
	ok def-format-test(
		Q{:@{#,#:^A}}, ( Nil ), Q{}
	), Q[format.:^.:@{.17];
	)

	#`(
	# (def-format-test format.\:^.\:@{.18
	#   ":@{#,#:^A}" ('(1))
	#   "")
	# 
	ok def-format-test(
		Q{:@{#,#:^A}}, ( [ 1 ] ), Q{}
	), Q[format.:^.:@{.18];
	)

	#`(
	# (def-format-test format.\:^.\:@{.19
	#   ":@{#,v:^A}" ('(1 2) '(3 4) '(2 5 6) '(1) '(2))
	#   "245" 1)
	# 
	ok def-format-test(
		Q{:@{#,v:^A}},
		( [ 1, 2 ], [ 3, 4 ], [ 2, 5, 6 ], [ 1 ], [ 2 ] ),
		Q{245},
		1
	), Q[format.:^.:@{.19];
	)

	#`(
	# (def-format-test format.\:^.\:@{.20
	#   ":@{V,#:^A}" ('(0 2) '(1 3 4) '(1 3) () '(0 7))
	#   "23" 2)
	# 
	ok def-format-test(
		Q{:@{V,#:^A}},
		( [ 0, 2 ], [ 1, 3, 4 ], [ 1, 3 ], [ ], [ 0, 7 ] ),
		Q{23},
		2
	), Q[format.:^.:@{.20];
	)

	#`(
	# (def-format-test format.\:^.\:@{.21
	#   ":@{'X,'Y:^A}" ('(1) '(2))
	#   "12")
	# 
	ok def-format-test(
		Q{:@{'X,'Y:^A}}, ( [ 1 ], [ 2 ] ), Q{12}
	), Q[format.:^.:@{.21];
	)

	#`(
	# (def-format-test format.\:^.\:@{.22
	#   ":@{'X,'X:^A}" ('(1) '(2))
	#   "" 1)
	# 
	ok def-format-test(
		Q{:@{'X,'X:^A}}, ( [ 1 ], [ 2 ] ), Q{}, 1
	), Q[format.:^.:@{.22];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.23
	#   ":@{1,2,3:^A}" ('(1) '(2))
	#   "" 1)
	# 
	ok def-format-test(
		Q{:@{1,2,3:^A}}, ( [ 1 ], [ 2 ] ), Q{}, 1
	), Q[format.:^.:@{.23];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.24
	#   ":@{1,2,1:^A}" ('(1) '(2))
	#   "12")
	# 
	ok def-format-test(
		Q{:@{1,2,3:^A}}, ( [ 1 ], [ 2 ] ), Q{}
	), Q[format.:^.:@{.24];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.25
	#   ":@{2,1,3:^A}" ('(1) '(2))
	#   "12")
	# 
	ok def-format-test(
		Q{:@{2,1,3:^A}}, ( [ 1 ], [ 2 ] ), Q{12}
	), Q[format.:^.:@{.25];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.26
	#   ":@{1,1,v:^A}" ('(0 4) '(nil 1) '(0 5))
	#   "4" 1)
	# 
	ok def-format-test(
		Q{:@{1,1,v:^A}},
		( [ 0, 4 ], [ Nil, 1 ], [ 0, 5 ] ),
		Q{4},
		1
	), Q[format.:^.:@{.26];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.27
	#   ":@{v,2,2:^A}" ('(3 4) '(1 1) '(4 5))
	#   "4" 1)
	# 
	ok def-format-test(
		Q{:@{v,2,2:^A}}, ( [ 3, 4 ], [ 1, 1 ], [ 4, 5 ] ), Q{4}, 1
	), Q[format.:^.:@{.27];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.28
	#   ":@{1,v,2:^A}" ('(0 2) '(3 4) '(1 1) '(4 5))
	#   "24" 1)
	# 
	ok def-format-test(
		Q{:@{1,v,2:^A}},
		( [ 0, 2 ], [ 3, 4 ], [ 1, 1 ], [ 4, 5 ] ),
		Q{24},
		1
	), Q[format.:^.:@{.28];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.29
	#   ":@{V,v,3:^A}" ('(1 4 0) '(2 1 7) '(4 4 8 0) '(1 2 6) '(9 8 0))
	#   "078" 1)
	# 
	ok def-format-test(
		Q{:@{V,v,3:^A}},
		( [ 1, 4, 0 ], [ 2, 1, 7 ], [ 4, 4, 8, 0 ],
		  [ 1, 2, 6 ], [ 9, 8, 0 ] ),
		Q{078},
		1
	), Q[format.:^.:@{.29];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.30
	#   ":@{v,2,v:^A}" ('(1 1 0) '(3 2 5) '(2 1 6) '(1 2 0) '(10 11 13))
	#   "056" 1)
	# 
	ok def-format-test(
		Q{:@{v,2,v:^A}},
		( [ 1, 1, 0 ], [ 3, 2, 5 ], [ 2, 1, 6 ],
		  [ 1, 2, 0 ], [ 10, 11, 13 ] ),
		Q{056},
		1
	), Q[format.:^.:@{.30];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.31
	#   ":@{2,V,v:^A}" ('(1 1 0) '(3 2 5) '(2 1 6) '(10 11 13) '(0 1 0))
	#   "056" 1)
	# 
	ok def-format-test(
		Q{:@{2,V,v:^A}},
		( [ 1, 1, 0 ], [ 3, 2, 5 ], [ 2, 1, 6 ],
		  [ 10, 11, 13 ], [ 0, 1, 0 ] ),
		Q{056},
		1
	), Q[format.:^.:@{.31];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.32
	#   ":@{v,v,V:^A}" ('(1 2 1 0) '(2 1 1 4) '(2 3 1 6) '(1 2 3) '(0 1 0 8))
	#   "046" 1)
	# 
	ok def-format-test(
		Q{:@{v,v,V:^A}},
		( [ 1, 2, 1, 0 ], [ 2, 1, 1, 4 ], [ 2, 3, 1, 6 ],
		  [ 1, 2, 3 ], [ 0, 1, 0, 8 ] ),
		Q{046},
		1
	), Q[format.:^.:@{.32];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.33
	#   ":@{#,2,2:^A}" ('(1 2 3) '(2 X X) '(0 A B C D) '(4 5) '(5 7 8 9))
	#   "120" 1)
	# 
	ok def-format-test(
		Q{:@{#,2,2:^A}},
		( [ 1, 2, 3 ], [ 2, Q{X}, Q{X} ], [ 0, Q{A}, Q{B}, Q{C}, Q{D} ],
		  [ 4, 5 ], [ 5, 7, 8, 9 ] ),
		Q{120},
		1
	), Q[format.:^.:@{.33];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.34
	#   ":@{2,#,3:^A}" ('(1) '(2 3 4 5) '(3 4) '(4 5 6 7 8) ())
	#   "12" 2)
	# 
	ok def-format-test(
		Q{:@{2,#,3:^A}},
		( [ 1 ], [ 2, 3, 4, 5 ], [ 3, 4 ], [ 4, 5, 6, 7, 8 ], [ ] ),
		Q{12},
		2
	), Q[format.:^.:@{.34];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.35
	#   ":@{1,3,#:^A}" ('(1) '(2 3) '(3 4) '(4 5 6) '(5))
	#   "123" 1)
	# 
	ok def-format-test(
		Q{:@{1,3,#:^A}},
		( [ 1 ], [ 2, 3 ], [ 3, 4 ], [ 4, 5, 6 ], [ 5 ] ),
		Q{123},
		1
	), Q[format.:^.:@{.35];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.36
	#   ":@{#,#,2:^A}" ('(1 2 3) '(2 X X) '(0 A B C D) '(4 5) '(5 7 8 9))
	#   "120" 1)
	# 
	ok def-format-test(
		Q{:@{#,#,2:^A}},
		( [ 1, 2, 3 ], [ 2, Q{X}, Q{X} ], [ 0, Q{A}, Q{B}, Q{C}, Q{D} ],
		  [ 4, 5 ], [ 5, 7, 8, 9 ] ),
		Q{120},
		1
	), Q[format.:^.:@{.36];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.37
	#   ":@{3,#,#:^A}" ('(1) '(2 3) '(3 4) '(4 5 6) '(5))
	#   "123" 1)
	# 
	ok def-format-test(
		Q{:@{3,#,#:^A}},
		( [ 1 ], [ 2, 3 ], [ 3, 4 ], [ 4, 5, 6 ], [ 5 ] ),
		Q{123},
		1
	), Q[format.:^.:@{.37];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.38
	#   ":@{#,2,#:^A}" ('(1 2 3) '(2) '(0 A B C D) '(4 5) '(5 7 8 9))
	#   "120" 1)
	# 
	ok def-format-test(
		Q{:@{#,2,#:^A}},
		( [ 1, 2, 3 ], [ 2 ], [ 0, Q{A}, Q{B}, Q{C}, Q{D} ],
		  [ 4, 5 ], [ 5, 7, 8, 9 ] ),
		Q{120},
		1
	), Q[format.:^.:@{.38];
	)

	#`(
	# (def-format-test  format.\:^.\:@{.39
	#   ":@{#,#,#:^A}" ('(1 2 3) '(2) '(0 A B C D) '(4 5) '(5 7 8 9))
	#   "" 4)
	# 
	ok def-format-test(
		Q{:@{#,#,#:^A}},
		( [ 1, 2, 3 ], [ 2 ], [ 0, Q{A}, Q{B}, Q{C}, Q{D} ],
		  [ 4, 5 ], [ 5, 7, 8, 9 ] ),
		Q{},
		4
	), Q[format.:^.:@{.38];
	)
}, Q[:^ in :@{];

# ;;; ^ inside ?, @?
# 
#`(
# (def-format-test format.^.?.1
#   "AY?XA" (1 "A0^A" '(2 4) 3)
#   "1Y2X3")
# 
ok def-format-test(
	Q{AY?XA}, ( 1, Q{A0^A}, [ 2, 4 ], 3 ), Q{1V2X3}
), Q[format.:^.?.1];
)

#`(
# (def-format-test format.^.?.2
#   "AY?XA" (1 "A^A" '(2) 3)
#   "1Y2X3")
# 
ok def-format-test(
	Q{AY?XA}, ( 1, Q{A^A}, [ 2 ], 3 ), Q{1V2X3}
), Q[format.:^.?.2];
)

#`(
# (def-format-test format.^.?.3
#   "AY?XA" (1 "A^A^A" '(2 4) 3)
#   "1Y24X3")
# 
ok def-format-test(
	Q{AY?XA}, ( 1, Q{A^A^A}, [ 2, 4 ], 3 ), Q{1V24X3}
), Q[format.:^.?.3];
)

#`(
# (def-format-test format.^.?.4
#   "A?XA" (1 "撖窿临立Жú畅旦订⒈渤促地盯镫溴姝骘蝽狒翦篝邀临控笼爆邀窿撖窿撖笼铂莠┈邀敝泊爻┈眼骘蝽狒恨慨齿｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻揽临揽佝立ū窿稗立穿⒈俨爻暴镫溴姝骘蝽狒翦篝邀临揽佝笼爆邀窿稗笼铂超┈邀敝藏除┈眼骘蝽狒恨揽陛｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻揽窿揽佝立ū撖窿临立Ж畅订⒈渤促地盯镫溴姝骘蝽狒翦篝邀窿揽佝笼爆邀撖窿临笼铂莠船惮┈邀辈炒俚囟┈眼骘蝽狒恨揽草篚怍弩被｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻苒圬毁悔箕稗蔺ěò穿⒇仝镫溴姝骘蝽狒翦篝邀圬毁悔箕稗蔺艾爆铂超┈邀刭邶┈邀骘蝽狒蕻郛饼｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻苒圬毁悔夯稗蔺ěū卑癌①刳镫溴姝骘蝽狒翦篝邀圬毁悔换稗蔺爆艾铂脯宫卑┈邀儇邶┈邀骘蝽狒蕻郛昌｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻苒圬毁稗蜗悔箕撖蔺ěò穿⒇佗镫溴姝骘蝽狒翦篝邀圬毁稗蜗悔箕撖蔺艾爆铂超┈邀刭┈邀骘蝽狒蕻郛除邀轭埤篚怍弩被｀ㄤ彐骘蝽狒翦篝骘蝽狒蕻塄摸摸稗摸┳" ('(#\X #\Y #\Z #\A))
	#   "xy")
	# 
	ok def-format-test(
		Q{摸摸稗摸┳}, ( [ Q{X}, Q{Y}, Q{Z}, Q{A} ] ), Q{xy}
	), Q[format.^.(.1];
	]

	#`[
	# (def-format-test format.^.\:\(.1
	#   "酣摸摸稗摸┱" ('(#\X #\Y #\Z #\A))
	#   "Xy")
	# 
	ok def-format-test(
		Q{酣摸摸稗摸┱}, ( [ Q{X}, Q{Y}, Q{Z}, Q{A} ] ), Q{Xy}
	), Q[format.^.:(.1];
	]

	#`[
	# (def-format-test format.^.@\(.1
	#   "括昧免稗摸┲" ('(#\x #\y #\Z #\A))
	#   "Xa yb ")
	# 
	ok def-format-test(
		Q{括昧免稗摸┲},
		( [ Q{x}, Q{y}, Q{Z}, Q{A} ] ),
		Q{Xa yb}
	), Q[format.^.@(.1];
	]

	#`[
	# (def-format-test format.^.@\:\(.1
	#   "篮昧免稗摸┳" ('(#\x #\Y #\Z #\A))
	#   "XA YB ")
	# 
	ok def-format-test(
		Q{篮昧免稗摸┳},
		( [ Q{x}, Q{Y}, Q{Z}, Q{A} ] ),
		Q{XA YB}
	), Q[format.^.@:(.1];
	]
}, Q{^ in (};

done-testing;

# vim: ft=perl6
